<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
      <meta name="robots" content="noindex">

    <title>Getting Started | Cloud Platform User Guide</title>

    <!--[if gt IE 8]><!--><link href="/stylesheets/screen.css" rel="stylesheet" media="screen" /><!--<![endif]-->
    <!--[if lte IE 8]><link href="/stylesheets/screen-old-ie.css" rel="stylesheet" media="screen" /><![endif]-->

    <link rel="canonical" href="https://user-guide.cloud-platform.service.justice.gov.uk/getting-started.html">


    <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
    <script src="/javascripts/application.js"></script>

      <meta property="og:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform User Guide" />
      <meta property="og:title" content="Getting Started" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/getting-started.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="user-guide.cloud-platform.service.justice.gov.uk" />
      <meta property="twitter:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Getting Started | Cloud Platform User Guide" />
      <meta property="twitter:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/getting-started.html" />

    
  </head>

  <body>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="skip-link">Skip to main content</a>

        <header class="header header--full-width">
  <div class="header__container">
    <div class="header__brand">
        <a href="/">
        <span class="header__title">
          Cloud Platform User Guide
            <span class="phase-banner">INTERNAL</span>
        </span>
        </a>
    </div>

      <div data-module="navigation">
        <button type="button" class="header__navigation-toggle js-nav-toggle" aria-controls="navigation" aria-label="Show or hide top level navigation">Menu</button>

        <nav id="navigation" class="header__navigation js-nav" aria-label="Top Level Navigation" aria-hidden="true">
          <ul>
              <li>
                <a href="/">Documentation</a>
              </li>
              <li>
                <a href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub</a>
              </li>
          </ul>
        </nav>
      </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://user-guide.cloud-platform.service.justice.gov.uk"/>
    <label for="search"  class="search__label">Search (via Google)</label>
    <input type="text" id="search" name="q" placeholder="Search" aria-controls="search-results" class="form-control" />
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="/#cloud-platform-user-guide">Cloud platform user guide</a>
    <ul>
      <li>
        <a href="/#cloud-platform-user-guide-overview">Overview</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/getting-started.html#getting-started">Getting Started</a>
    <ul>
      <li>
        <a href="/getting-started.html#kubectl-configuration">kubectl configuration</a>
      </li>
      <li>
        <a href="/getting-started.html#creating-a-cloud-platform-environment">Creating a Cloud Platform Environment</a>
      </li>
      <li>
        <a href="/getting-started.html#creating-an-ecr-repository">Creating an ECR repository</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/deploying-applications.html#deploying-applications">Deploying Applications</a>
    <ul>
      <li>
        <a href="/deploying-applications.html#deploying-a-39-hello-world-39-application-to-the-cloud-platform">Deploying a ‘Hello World’ application to the Cloud Platform</a>
      </li>
      <li>
        <a href="/deploying-applications.html#deploying-a-multi-container-application-to-the-cloud-platform">Deploying a multi-container application to the Cloud Platform</a>
      </li>
      <li>
        <a href="/deploying-applications.html#deploying-an-application-to-the-cloud-platform-with-helm">Deploying an application to the Cloud Platform with Helm</a>
      </li>
      <li>
        <a href="/deploying-applications.html#adding-a-secret-to-an-application">Adding a secret to an application</a>
      </li>
      <li>
        <a href="/deploying-applications.html#continuous-deployment-of-an-application-using-circleci-and-helm">Continuous Deployment of an application using CircleCI and Helm</a>
      </li>
      <li>
        <a href="/deploying-applications.html#adding-aws-resources-to-your-environment">Adding AWS resources to your environment</a>
      </li>
      <li>
        <a href="/deploying-applications.html#cleaning-up">Cleaning up</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/monitoring-applications.html#monitoring-applications">Monitoring Applications</a>
    <ul>
      <li>
        <a href="/monitoring-applications.html#using-the-cloud-platform-prometheus-alertmanager-and-grafana">Using the Cloud Platform Prometheus, AlertManager and Grafana</a>
      </li>
      <li>
        <a href="/monitoring-applications.html#creating-your-own-custom-alerts">Creating your own custom alerts</a>
      </li>
      <li>
        <a href="/monitoring-applications.html#getting-application-metrics-into-prometheus">Getting Application Metrics into Prometheus</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/other-topics.html#other-topics">Other Topics</a>
    <ul>
      <li>
        <a href="/other-topics.html#git-crypt">Git-Crypt</a>
      </li>
      <li>
        <a href="/other-topics.html#secrets-overview">Secrets overview</a>
      </li>
      <li>
        <a href="/other-topics.html#kubectl-quick-reference">Kubectl quick reference</a>
      </li>
      <li>
        <a href="/other-topics.html#how-to-access-my-log-data-using-kibana">How to access my log data using Kibana</a>
      </li>
      <li>
        <a href="/other-topics.html#kubernetes-basics-links-to-helpful-beginner-resources">Kubernetes Basics - Links to helpful beginner resources</a>
      </li>
      <li>
        <a href="/other-topics.html#cloud-platform-support">Cloud Platform Support</a>
      </li>
      <li>
        <a href="/other-topics.html#zero-downtime-deployments">Zero Downtime Deployments</a>
      </li>
      <li>
        <a href="/other-topics.html#contributing-to-this-document">Contributing to this document</a>
      </li>
      <li>
        <a href="/other-topics.html#using-an-externally-managed-hostname">Using an externally-managed hostname</a>
      </li>
      <li>
        <a href="/other-topics.html#ip-whitelisting">IP Whitelisting</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/getting-help.html#getting-help">Getting Help</a>
    <ul>
      <li>
        <a href="/getting-help.html#slack-channel">Slack Channel</a>
      </li>
      <li>
        <a href="/getting-help.html#raise-a-support-ticket">Raise a support ticket</a>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/deprecation-warning.html#live-0-cluster-deprecation-notice">LIVE-0 CLUSTER DEPRECATION NOTICE</a>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="getting-started">Getting Started</h1>
<p><h2 id="kubectl-configuration"><code>kubectl</code> configuration</h2><h3 id="overview">Overview</h3><p>The aim of this guide is to provide a walkthrough of the installation of the <code>kubectl</code> command-line tool, the official command-line tool for Kubernetes, as well as setting it up by authenticating with the Cloud Platform cluster.</p>
<p><code>kubectl</code> is used to deploy and manage applications on Kubernetes and is fundamental for anyone who wants to interact with the cluster.</p>
<p>When complete you should have access to perform API calls via a tool called <code>kubectl</code>.</p>
<h3 id="installation">Installation</h3><p>Please read the <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">official documentation</a> on how to install <code>kubectl</code>.</p>
<h3 id="authentication">Authentication</h3><p>You must have a GitHub account and be a member of the Ministry of Justice Organisation.</p>
<p>For our use case, we want authentication and identity to be handled by Github, and to derive all cluster access control from Github teams - projects will be deployed into namespaces (e.g. <code>pvb-production</code>, <code>cla-staging</code>), and access to resources in those namespaces should be available to the appropriate teams only (e.g. <code>PVB</code> and <code>CLA</code> teams).</p>
<p>Kubernetes supports authentication from external identity providers, including group definition, via <a href="https://kubernetes.io/docs/admin/authentication/#openid-connect-tokens">OIDC</a>. Github however only support OAuth2 as an authentication method, so an identity broker is required to translate from OAuth2 to OIDC.</p>
<p>As work on MOJ&rsquo;s identity service is ongoing, a development <a href="https://www.auth0.com">Auth0</a> account has been created to act as a standin in the meantime.</p>
<h4 id="live-clusters">Live clusters</h4><p>Live clusters are those available to users:</p></p>

<div style="height:1px;font-size:1px;">&nbsp;</div>

<div class="table-container">
        <table>
          <tr>
<th>Cluster Name</th>
<th>Login page</th>
</tr>
<tr>
<td><code>cloud-platform-live-0</code></td>
<td><a href="https://login.apps.cloud-platform-live-0.k8s.integration.dsd.io/">https://login.apps.cloud-platform-live-0.k8s.integration.dsd.io/</a></td>
</tr>

        </table>
      </div>

<div style="height:1px;font-size:1px;">&nbsp;</div>
<p><h4 id="how-do-i-connect-to-a-cluster">How do I connect to a cluster?</h4><p>We employ <a href="https://github.com/negz/kuberos">Kuberos</a> to help with the setup, a service that can generate the client configuration for users.</p>
<p>To authenticate with a cluster, please follow the steps below;</p></p>

<ul>
<li>Navigate to a login page from the table above</li>
<li>Click the login with GitHub option and authorise kuberos</li>
<li>Follow the instructions on the page presented, once finished you should have a <a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/"><code>kubeconfig</code></a> file in <code>~/.kube/config</code>.</li>
<li>You should now be able to run <code>kubectl</code> commands; try running such <code>kubectl get namespaces</code></li>
</ul>
<p><h5 id="troubleshooting-quot-current-quot-context">Troubleshooting: &ldquo;current&rdquo; context</h5><p>If you receive <code>The connection to the server localhost:8080 was refused</code> errors while executing <code>kubectl</code> commands,
check that your &ldquo;current&rdquo; context is set.</p>
<p>Run <code>kubectl config get-contexts</code>:
<code>
CURRENT   NAME                                           CLUSTER                                        AUTHINFO                 NAMESPACE
          cloud-platform-live-0.k8s.integration.dsd.io   cloud-platform-live-0.k8s.integration.dsd.io   &lt;your github e-mail&gt;
</code></p>
<p>Set the context you want to use as &ldquo;current&rdquo; with: <code>kubectl config use-context &lt;NAME&gt;</code>.</p>
<p>E.g. <code>kubectl config use-context cloud-platform-live-0.k8s.integration.dsd.io</code></p>
<h4 id="multiple-clusters">Multiple clusters</h4><p>To setup additional clusters, follow the process above and save the generated <code>kubeconfig</code> with a different filename (eg.: <code>~/.kube/config_live0</code>).</p>
<p>You can then use the <code>KUBECONFIG</code> environment variable to have <code>kubectl</code> parse the additional configuration files, eg.: <code>KUBECONFIG=~/.kube/config:~/.kube/config_live0</code></p>
<p>For more information please read the <a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">official documentation</a></p>
<h5 id="usernames">Usernames</h5><p>By default, Kuberos will use your email address as the username in the generated <code>kubeconfig</code>.</p>
<p>When setting up multiple clusters, this will generate conflicts so you should rename the users by editing the files (and update the contexts appropriately).</p>
<h3 id="where-to-go-from-here">Where to go from here?</h3><p>Now that you&rsquo;ve setup <code>kubectl</code>, you might want to look at this handy <a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/">cheatsheet</a>.</p>
<p>Once you are ready to deploy applications you will need to create an environment first.</p></p>
<p><h2 id="creating-a-cloud-platform-environment">Creating a Cloud Platform Environment</h2><h3 id="introduction">Introduction</h3><p>This is a guide to creating a environment in one of our Kubernetes clusters.</p>
<p>We define an environment as a Kubernetes <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a> with some key resources deployed in it. Each Kubernetes namespace creates a logical separation within our cluster that provides isolation from any other namespace.</p>
<p>Once you have created an environment you will be able to perform actions using the <code>kubectl</code> tool in the namespace you have created.</p>
<h3 id="objective">Objective</h3><p>By the end of this guide you&rsquo;ll have created a Kubernetes namespace ready for you to <a href="/deploying-applications.html#deploying-a-39-hello-world-39-application-to-the-cloud-platform">deploy an application</a> into.</p>
<h3 id="create-an-environment">Create an environment</h3><p>You create an environment by adding the definition of the environment in YAML to the following repository, hosted on GitHub:</p>
<p><a href="https://github.com/ministryofjustice/cloud-platform-environments">cloud-platform-environments</a></p>
<p>Adding your environment definition kicks off a pipeline which builds your environment on the appropriate cluster.</p>
<h4 id="set-up">Set up</h4><p>First we need to clone the repository, change directory and create a new branch:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ git clone git@github.com:ministryofjustice/cloud-platform-environments.git
$ cd cloud-platform-environments
$ git checkout -b &lt;yourBranch&gt;
</code></pre></div><h4 id="the-directory-structure">The directory structure</h4><p>We build new environments by creating a new directory for our environment and putting the YAML files that define the environment into that directory. To understand where to create the directory it is useful to understand the overall structure of the repo:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cloud-platform-environments
├── namespace-resources
└── namespaces
    └── cloud-platform-live-0.k8s.integration.dsd.io
        ├── kube-system</p>
<div class="highlight"><pre class="highlight plaintext"><code>    ...

    └── user-roles.yaml
</code></pre></div><p></code></pre></div><p><strong>cloud-platform-environments</strong></p>
<p>This is the root of the repo, containing <code>namespaces</code> directory</p>
<p><strong>/namespaces</strong></p>
<p>The namespaces directory contains a directory for each of the clusters that you can build environments on. Create your environment in the <code>cloud-platform-live-0.k8s.integration.dsd.io</code> directory.</p>
<p><strong>/namespaces/cloud-platform-live-0.k8s.integration.dsd.io/</strong></p>
<p>Within the cluster directory you will generate a directory for your environment in the format <code>&lt;servicename-env&gt;</code>, for example <code>myapp-dev</code>.</p>
<p><strong>/namespaces/cloud-platform-live-0.k8s.integration.dsd.io/servicename-env/</strong></p>
<p>The <code>&lt;servicename-env&gt;</code> directory for your environment defines the specific resources we will create in your namespace. We describe these resources in more detail in <a href="##how-we-set-up-an-environment">how we set up an environment</a>.</p>
<h4 id="how-we-set-up-an-environment">How we set up an environment</h4><p>To set up an environment we create 5 files in the directory for your namespace:</p></p>

<ul>
<li><a href="##00-namespaceyaml"><code>00-namespace.yaml</code></a></li>
<li><a href="##01-rbacyaml"><code>01-rbac.yaml</code></a></li>
<li><a href="##02-limitrangeyaml"><code>02-limitrange.yaml</code></a></li>
<li><a href="##03-resourcequotayaml"><code>03-resourcequota.yaml</code></a></li>
<li><a href="##04-networkpolicyyaml"><code>04-networkpolicy.yaml</code></a></li>
</ul>

<p>These files define key elements of the namespace and restrictions we want to place on it so that we have security and resource allocation properties. We will use terraform to create these files from templates. We also describe each of these files <a href="##00-namespaceyaml">in more detail below</a> in case you want to make future changes.</p>
<p><h4 id="create-your-namespace-and-namespace-resources">Create your namespace and namespace resources</h4><p>We automate the creation of the namespace resource files using terraform. You will need to install terraform locally:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ brew install terraform
</code></pre></div><p>In each of the template files you need to replace some example values with information about your namespace, team or app. We do this by running terraform commands and filling in the values.</p>
<p>These are the inputs for the terraform module, that you will need to fill:</p></p>

<div style="height:1px;font-size:1px;">&nbsp;</div>

<div class="table-container">
        <table>
          <tr>
<th>Name</th>
<th>Description</th>
<th style="text-align: center">Type</th>
<th style="text-align: center">Default</th>
<th style="text-align: center">Required</th>
</tr>
<tr>
<td>application</td>
<td>The name of your application</td>
<td style="text-align: center">string</td>
<td style="text-align: center">-</td>
<td style="text-align: center">yes</td>
</tr>
<tr>
<td>business-unit</td>
<td>Area of the MOJ responsible for the service</td>
<td style="text-align: center">string</td>
<td style="text-align: center">-</td>
<td style="text-align: center">yes</td>
</tr>
<tr>
<td>cluster</td>
<td>What cluster are you deploying your namespace. i.e cloud-platform-test-1</td>
<td style="text-align: center">string</td>
<td style="text-align: center"><code>cloud-platform-live-0</code></td>
<td style="text-align: center">no</td>
</tr>
<tr>
<td>contact_email</td>
<td>Contact email address for owner of the application</td>
<td style="text-align: center">string</td>
<td style="text-align: center">-</td>
<td style="text-align: center">yes</td>
</tr>
<tr>
<td>environment</td>
<td>A label for your environment (e.g. dev/staging/&hellip;)</td>
<td style="text-align: center">string</td>
<td style="text-align: center">-</td>
<td style="text-align: center">yes</td>
</tr>
<tr>
<td>github_team</td>
<td>This is your team name as defined by the GITHUB api. This has to match the team name on the Github API</td>
<td style="text-align: center">string</td>
<td style="text-align: center">-</td>
<td style="text-align: center">yes</td>
</tr>
<tr>
<td>is-production</td>
<td></td>
<td style="text-align: center">string</td>
<td style="text-align: center"><code>false</code></td>
<td style="text-align: center">no</td>
</tr>
<tr>
<td>namespace</td>
<td>Namespace you would like to create on cluster <application>-<environment>. i.e myapp-dev</td>
<td style="text-align: center">string</td>
<td style="text-align: center">-</td>
<td style="text-align: center">yes</td>
</tr>
<tr>
<td>owner</td>
<td>Who is the owner/Who is responsible for this application</td>
<td style="text-align: center">string</td>
<td style="text-align: center">-</td>
<td style="text-align: center">yes</td>
</tr>
<tr>
<td>source_code_url</td>
<td>Url of the source code for your application</td>
<td style="text-align: center">string</td>
<td style="text-align: center">-</td>
<td style="text-align: center">yes</td>
</tr>

        </table>
      </div>

<div style="height:1px;font-size:1px;">&nbsp;</div>

<p>Run the following commands to create your namespace and these resources files:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ cd cloud-platform-environments/namespace-resources/
$ terraform init
$ terraform apply
</code></pre></div><p>Our terraform module creates the files for a new namespace on the live-0 cluster by default but if you would like to deploy to another cluster you can use:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ terraform apply -var "cluster=&lt;cluster-name&gt;"
</code></pre></div><p>Fill in your values in response to the prompts.</p>
<p>For <code>var.namespace</code>, this is the name of your (team&rsquo;s) &lsquo;private&rsquo; part of the cluster. The name of your namespace must be unique across the whole of the cluster. If you try to create a new namespace using the name of one which already exists, you will get an error when you try to apply the generated kubernetes config files (or when our build pipeline applies them on your behalf).</p>
<p>For &lsquo;real&rsquo; services, this is very unlikely to be a problem - most services have distinct names, so namespace name conflicts are unlikely. But, if you are creating a test/dummy namespace in order to learn how the platform works, it&rsquo;s better to avoid generic names like &#39;dummy&rsquo;, &#39;test&rsquo; or &#39;example&rsquo;. Add something unique (e.g. your name) to minimise the risk of trying to re-use a name by mistake.</p>
<p>For <code>var.source_code_url</code>, this should be the URL of an application which is &#39;cluster-ready&rsquo; to be deployed. If you do not have such an application ready to go, you can use the reference application which the Cloud Platform team have prepared <code>git@github.com:ministryofjustice/cloud-platform-reference-app.git</code></p>
<p>Note: The <code>source_code_url</code> is a descriptive label, used by the Cloud Platform team in supporting your namespace. It does not set up an explicit link between your namespace and your application&rsquo;s code repository.</p>
<p>At the final prompt &ldquo;Do you want to perform these actions?&rdquo;, enter &ldquo;yes&rdquo;</p>
<p>You can then access your namespace files under <code>cloud-platform-environments/namespaces/cloud-platform-live-0.k8s.integration.dsd.io/&lt;your-namespace&gt;</code>, if satisfied you can then push the changes to your branch and create a pull request against the <a href="https://github.com/ministryofjustice/cloud-platform-environments"><code>cloud-platform-environments</code></a> master repo.</p>
<p>The cloud platform team will review the pull request when it gets opened.  As soon as the pull request has been approved by the cloud platform team you can then merge it into the master branch which will kick off the pipeline that builds the environment. You can check whether the build succeeded or failed in the <a href="https://mojdt.slack.com/messages/CA5MDLM34/"><code>##cp-build-notifications</code></a> slack channel. This can take about 5 minutes.</p>
<h3 id="accessing-your-environments">Accessing your environments</h3><p>Once the pipeline has completed you will be able to check that your environment is available by running:</p>
<p><code>$ kubectl get namespaces</code></p>
<p>This will return a list of the namespaces within the cluster, and you should see yours in the list.</p>
<p>You can now run commands in your namespace by appending the <code>-n</code> or <code>--namespace</code> flag to <code>kubectl</code>. So for instance, to see the pods running in our <code>myenv-dev</code> namespace, we would run:</p>
<p><code>$ kubectl get pods -n myenv-dev</code> or</p>
<p><code>$ kubectl get pods --namespace myenv-dev</code></p>
<h3 id="next-steps">Next steps</h3><p><a href="/getting-started.html#creating-an-ecr-repository">Create an ECR repository</a> to push your application docker image to.</p>
<p>Then you can try <a href="/deploying-applications.html#deploying-a-39-hello-world-39-application-to-the-cloud-platform">deploying an app to Kubernetes manually</a> by writing some custom YAML files or <a href="/deploying-applications.html#deploying-an-application-to-the-cloud-platform-with-helm">deploying an app with Helm</a>, a Kubernetes <a href="(https://helm.sh/)">package manager</a>.</p>
<h3 id="more-information-on-environment-definition">More information on environment definition</h3><p>To set up an environment we create 5 files in that directory:</p>

<ul>
<li><a href="##00-namespaceyaml"><code>00-namespace.yaml</code></a></li>
<li><a href="##01-rbacyaml"><code>01-rbac.yaml</code></a></li>
<li><a href="##02-limitrangeyaml"><code>02-limitrange.yaml</code></a></li>
<li><a href="##03-resourcequotayaml"><code>03-resourcequota.yaml</code></a></li>
<li><a href="##04-networkpolicyyaml"><code>04-networkpolicy.yaml</code></a></li>
</ul>
<p>These files define key elements of the namespace and restrictions we want to place on it so that we have security and resource allocation properties. We will use terraform to create these files from templates. We also describe each of these files in more detail below in case you want to make changes.</p>
<h4 id="00-namespace-yaml"><code>00-namespace.yaml</code></h4><p>The <code>00-namespace.yaml</code> file defines the namespace so that the cluster Kubernetes knows to create a namespace and what to call it.</p>
<div class="highlight"><pre class="highlight plaintext"><code>apiVersion: v1
kind: Namespace
metadata:
  name: myapp-dev ## This is where you will define your &lt;servicename-env&gt;
  labels:
    name: myapp-dev ## Also your &lt;servicename-env&gt;
</code></pre></div><h4 id="01-rbac-yaml"><code>01-rbac.yaml</code></h4><p>We will also create a <code>RoleBinding</code> resource by adding the <code>01-rbac.yaml</code> file. This will provide us with <a href="https://kubernetes.io/docs/admin/authorization/rbac/">access policies</a> on the namespace we have created in the cluster.</p>
<p>A role binding resource grants the permissions defined in a role to a user or set of users. A role can be another resource we can create but in this instance we will reference a Kubernetes default role <code>ClusterRole - admin</code>.</p>
<p>This <code>RoleBinding</code> resource references the <code>ClusterRole - admin</code> to provide  admin permissions on the namespace to the set of users defined under <code>subjects</code>. In this case, the <code>&lt;yourTeam&gt;</code> GitHub group will have admin access to any resources within the namespace <code>myapp-dev</code>.</p>
<div class="highlight"><pre class="highlight plaintext"><code>kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: myapp-dev-admins  ## Your namespace with `-admin` e.g. `&lt;servicename-env&gt;-admin`
  namespace: myapp-dev ## Your namespace `&lt;servicename-env&gt;`
subjects:
  - kind: Group
    name: "github:&lt;yourTeam&gt;" ## Make this the name of the GitHub team you want to give access to
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: admin
  apiGroup: rbac.authorization.k8s.io
</code></pre></div><h4 id="02-limitrange-yaml"><code>02-limitrange.yaml</code></h4><p>As we are working on a shared Kubernetes cluster it is useful to put in place limits on the resources that each namespace, pod and container can use. This helps to stop us accidentally entering a situation where one service impacts the performance of another through using more resources than are available.</p>
<p>The first Kubernetes limit we can use is a <a href="https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/">LimitRange</a> which we define in <code>02-limitrange.yaml</code>.</p>
<p>The LimitRange object specifies two key resource limits on containers, <code>defaultRequest</code> and <code>default</code>. <code>defaultRequest</code> is the memory and cpu a container will request on startup. This is what the Kubernetes scheduler uses to determine whether there is enough space on the cluster to run your application and what your application will start up with when it is created. <code>default</code> is the limit at which your application will be killed or throttled.</p>
<p>In <code>02-limitrange.yaml</code> you need to change the value of the <code>namespace</code> key to match the name of your namespace in the form <code>&lt;service-env&gt;</code>. We have set default values for the limits in the templates. As you learn more about the behaviour of your applications on Kubernetes you can change them.</p>
<div class="highlight"><pre class="highlight plaintext"><code>apiVersion: v1
kind: LimitRange
metadata:
  name: limitrange
  namespace: myapp-dev ## Your namespace `&lt;servicename-env&gt;`
spec:
  limits:
  - default:
      cpu: 1000m
      memory: 2Gi
    defaultRequest:
      cpu: 100m
      memory: 128Mi
    type: Container
</code></pre></div><h4 id="03-resourcequota-yaml"><code>03-resourcequota.yaml</code></h4><p>The <a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/">ResourceQuota</a> object allows us to set a total limit on the resources used in a namespace. As with the LimitRange, the <code>requests.cpu</code> and <code>requests.memory</code> limits set how much the namespace will request on creation. The <code>limits.cpu</code> and <code>limits.memory</code> define the overall hard limits for the namespace.</p>
<p>In <code>03-resourcequota.yaml</code> you need to change the value of the <code>namespace</code> key to match the name of your namespace in the form <code>&lt;service-env&gt;</code>. We have set default values for the limits in the templates. As you learn more about the behaviour of your applications on Kubernetes you can change them.</p>
<div class="highlight"><pre class="highlight plaintext"><code>apiVersion: v1
kind: ResourceQuota
metadata:
  name: namespace-quota
  namespace: myapp-dev ## Your namespace `&lt;servicename-env&gt;`
spec:
  hard:
    requests.cpu: 4000m
    requests.memory: 8Gi
    limits.cpu: 6000m
    limits.memory: 12Gi
</code></pre></div><h4 id="04-networkpolicy-yaml"><code>04-networkpolicy.yaml</code></h4><p>The <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">NetworkPolicy</a> object defines how groups of pods are allowed to communicate with each other and other network endpoints. By default pods are non-isolated, they accept traffic from any source. We apply a network policy to restrict where traffic can come from, allowing traffic only from the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">ingress controller</a> and other pods in your namespace.</p>
<p>In <code>04-networkpolicy.yaml</code> you need to change the value of the <code>namespace</code> key to match the name of your namespace in the form <code>&lt;service-env&gt;</code>.</p>
<div class="highlight"><pre class="highlight plaintext"><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default
  namespace: myapp-dev ## Your namespace `&lt;servicename-env&gt;`
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector: {}
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: allow-ingress-controllers
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          component: ingress-controllers
</code></pre></div>
<p><h2 id="creating-an-ecr-repository">Creating an ECR repository</h2><h3 id="creating-an-ecr-repository-introduction">Introduction</h3><p>This guide will guide you through the creation of an ECR (Elastic Container Registry) repository for your application&rsquo;s docker image.</p>
<p>AWS resources are provisioned through the <a href="https://github.com/ministryofjustice/cloud-platform-environments/">cloud-platform-environments</a> repository, per environment. Your application might be using multiple namespaces, however you typically only need one image repository and once created in any of them you can copy credentials for it to the others via <code>kubectl get/create secret</code>.</p>
<h4 id="creating-the-registry">Creating the registry</h4><p>1. In order to create the ECR Docker registry, git clone the repo and create a new branch.</p>
<div class="highlight"><pre class="highlight shell"><code>
  <span class="nv">$ </span>git clone git@github.com:ministryofjustice/cloud-platform-environments.git <span class="c">##git clone repo</span></p>
<p><span class="nv">$ </span><span class="nb">cd </span>cloud-platform-environments <span class="c">## navigate into cloud-platform-environments directory.</span></p>
<p><span class="nv">$ </span>git checkout <span class="nt">-b</span> add_ecr   <span class="c">## create and checkout new branch.</span></p>
<p></code></pre></div><p>2. You will need to navigate to your service&rsquo;s directory which is located in the namespaces directory. Create a directory named &ldquo;resources&rdquo;.</p>
<div class="highlight"><pre class="highlight shell"><code>
  <span class="nv">$ </span><span class="nb">cd </span>namespaces/cloud-platform-live-0.k8s.integration.dsd.io/<span class="nv">$your_service</span>  <span class="c">##navigate to your service&#39;s directory.</span></p>
<p><span class="nv">$ </span>mkdir resources <span class="c">## make directory called resources</span></p>
<p><span class="nv">$ </span><span class="nb">cd </span>namespaces/cloud-platform-live-0.k8s.integration.dsd.io/<span class="nv">$your_service</span>/resources</p>
<p></code></pre></div><p>3. Create a terraform file within the resources directory.</p>
<div class="highlight"><pre class="highlight shell"><code>
  <span class="nv">$ </span>vi ecr.tf  <span class="c">##create a terraform file.</span></p>
<p></code></pre></div><p>4. Adapt the definition from the example described in the <a href="https://github.com/ministryofjustice/cloud-platform-terraform-ecr-credentials/tree/master/examples">cloud-platform-terraform-ecr-credentials module</a>; make sure you adjust the values of <code>team_name</code>, <code>repo_name</code> <code>name</code> and <code>namespace</code> to what is appropriate for your environment.</p>
<p>Note: A default ECR lifecycle policy is set, that will only keep the 40 most recent versions of an image.</p>
<p>5. git add, commit and push to your branch.</p>
<div class="highlight"><pre class="highlight shell"><code>
  <span class="nv">$ </span>git add ecr.tf</p>
<p><span class="nv">$ </span>git commit</p>
<p><span class="nv">$ </span>git push</p>
<p></code></pre></div><p>6. Once your request has been approved and the branches are merged, it will trigger our build pipeline which will apply the Terraform module and create the resources.</p>
<p>For more information about the terraform module being used, please read the documentation <a href="https://github.com/ministryofjustice/cloud-platform-terraform-ecr-credentials">here</a>.</p>
<h3 id="accessing-the-credentials">Accessing the credentials</h3><p>The end result will be a kubernetes <code>Secret</code> inside your environment, called <code>example-team-ecr-credentials-output</code> (or whatever you changed that to); the secret holds IAM access keys to authenticate with the registry and the actual repository URL.</p>
<p>Note: For <code>example-team-ecr-credentials-output</code> you should put whatever you used as the value of the <code>name</code> property of the <code>kubernetes_secret</code> resource in the <code>ecr.tf</code> file you created previously.</p>
<p>To retrieve the credentials:
<code>
kubectl -n &lt;namespace_name&gt; get secret example-team-ecr-credentials-output -o yaml
</code></p>
<p>The values in kubernetes <code>Secrets</code> are always <code>base64</code> encoded so you will have to decode them before you can use them outside kubernetes. Inside the cluster, the nodes already have access to the ECR so you don&rsquo;t need to make any changes.</p>
<p>This can be done at the command line using the following:
<code>
echo QWxhZGRpbjpvcGVuIHNlc2FtZQ== | base64 --decode; echo
</code></p>
<h4 id="setting-up-circleci">Setting up CircleCI</h4><p>In your CircleCI project, go to the settings (the cog icon) and select &lsquo;AWS Permissions&rsquo; from the left hand menu. Fill in the IAM credentials and CircleCI will be able to use ECR images. For more information please see <a href="https://circleci.com/docs/2.0/private-images/">the official docs</a>.</p>
<h3 id="creating-an-ecr-repository-next-steps">Next steps</h3><p>Try <a href="/deploying-applications.html#deploying-an-application-to-the-cloud-platform-with-helm">deploying an app</a> with <a href="https://helm.sh/">Helm</a>, a Kubernetes package manager, or <a href="/deploying-applications.html#deploying-a-39-hello-world-39-application-to-the-cloud-platform">deploying manually</a> by writing some custom YAML files.</p></p>


            
          </main>

            <ul class="contribution-banner">
              <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/blob/master/source/getting-started.html.md.erb">View source</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/issues/new?labels=bug&amp;title=Re:%20'Getting%20Started'&amp;body=Problem%20with%20'Getting%20Started'%20(https://user-guide.cloud-platform.service.justice.gov.uk/getting-started.html)">Report problem</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub Repo</a></li>
            </ul>

          <footer class="footer">
  <div class="footer__licence">
    <a class="footer__licence-logo" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence</a>
    <p class="footer__licence-description">All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence v3.0</a>, except where otherwise stated</p>
  </div>

  <div class="footer__copyright">
    <a class="footer__copyright-logo" href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/copyright-and-re-use/crown-copyright/">© Crown copyright</a>
  </div>
</footer>

        </div>
      </div>
    </div>

    
  </body>
</html>
