---
title: CircleCI Security Incident - Post Secret Rotation Guidance
last_reviewed_on: 2023-01-13
review_in: 3 months
---

# <%= current_page.data.title %>

## Overview

Following the announcement of the [CircleCI Security Alert](https://circleci.com/blog/january-4-2023-security-alert/) issued 04/01/2023, the Cloud Platform
team has been focusing on working to ensure that all secrets impacted by this event have been rotated.

For all Cloud Platform hosted applications utilising CircleCI, this will require at least two distinct remediation
activities to be completed.


### CircleCI Service Account Tokens

We have carried out a full rotation of all CircleCI Service Accounts, which means that all CircleCI projects
will need to have their Service Account tokens updated.

To view your new Service Account you can run the following:

```bash
  $ kubectl get serviceaccounts --namespace <YOUR-NAMESPACE>
  NAME       SECRETS   AGE
  circleci   1         3h

  $ kubectl get serviceaccounts/circleci --namespace <YOUR-NAMESPACE> -o yaml
  apiVersion: v1
  kind: ServiceAccount
  ...
  secrets:
  - name: circleci-token-prlkp
```

You can obtain your updated service account `token` using the `cloud-platform decode-secret` CLI command:

```bash
$ cloud-platform decode-secret -n <YOUR-NAMESPACE> -s <NAME-OF-CIRCLECI-SERVICE-ACCOUNT-SECRET> | jq -r '.data."token"'
```

For instructions on adding the new `token` value to CircleCI, refer to this [article]. Note that for this activity, it is 
only the `token` variable you are updating, and that the variable name `K8S_TOKEN` as used in this article may differ to yours.

### AWS Access Key ID and Secret Access Keys

>IMPORTANT: It is the responsibility of application owners to identify and carry out any remediation activites to update these values
>wherever they are used for their service. It is for this reason that the team has elected to follow a 'user merge' managed approach 
>for triggering the rotation of these secrets.

The Cloud Platform team will raise a PR on your behalf which will you will be asked to merge. Upon merging, this PR will trigger a 
recreation of all module AWS secrets.

If your Cloud Platform workload utilises any of the following Cloud Platform Terraform Modules, AWS Access ID and Secret Access Keys will
be rotated. 

<!--  a reference here to phase 2 process OR refer to comms guidance-->

- RDS
- RDS Aurora
- DynamoDB
- S3
- SNS Topic
- SQS
- ElastiCache
- ECR

All of these modules utilise the same mechanism for enabling access to AWS credentials for Cloud Platform users; by creating an associated
Kubernetes `secret` containing the values in your namespace.

Once your namespace rotation pull request has been merged and applied via our Concourse pipeline, you can obtain your new AWS secrets values
as follows:

```bash
$ kubectl  -n <YOUR-NAMESPACE> get secret <AWS-RESOURCE-SECRET>  -o yaml
```

Or use the `cloud-platform decode-secret` CLI command to automatically base64 decode the values:

```bash
$ cloud-platform decode-secret -n <YOUR-NAMESPACE> -s <AWS-RESOURCE-SECRET>
```

>NOTE: There are teams which will be sharing AWS resource secrets to other relying namespaces. This will need to be taken into
>consideration as applications running in these other namespaces will also be impacted.

<!--HOW TO CHECK K8S SECRET HAS BEEN UPDATED-->

### How do I know when my secrets rotation has completed?

Since the module secrets rotation process updates existing Kubernetes `secrets` in namespaces rather than replacing them entirely, it
is not possible to rely on checking the age of your `secrets` as this will not change. There are two checks that you can follow to 
confirm rotation has completed:

- Monitoring the Concourse `apply-namespace-changes-live` pipeline for your PR. Each job run in this pipeline outputs the following 
information at the beginning of the `task: apply-namespace-changes` stage:

```
Found PR: [PR number]
Applying Namespace: [namespace being applied]
```
The Concourse pipeline URL will be provided via comms during the rotation process.

- Conducting a "before and after" check of your AWS secrets values using the above `kubectl` or `cloud-platform decode-secret` CLI
commands. Once you have observed these have been updated you are ready to proceed with post rotation activities.



### AWS IAM User Resources

<!-- TO DO -->

### RDS Database Password Rotation

<!-- WIP -->

In the coming weeks, we will also be rotating all impacted RDS database passwords as a matter of diligence.


[article]: https://user-guide.cloud-platform.service.justice.gov.uk/documentation/deploying-an-app/using-circleci-for-continuous-deployment.html#add-variables-to-circleci